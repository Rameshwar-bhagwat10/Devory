generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  STUDENT
  ADMIN
}

enum ProjectDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ProjectDomain {
  WEB_DEVELOPMENT
  MOBILE_DEVELOPMENT
  DATA_SCIENCE
  MACHINE_LEARNING
  BLOCKCHAIN
  IOT
  GAME_DEVELOPMENT
  CYBERSECURITY
  CLOUD_COMPUTING
  FINTECH
  DEVOPS
  HEALTH_TECH
  ENTERPRISE_SYSTEM
  AI_ML
  EDTECH
  MOBILE
  OTHER
}

enum IdeaStatus {
  PENDING
  APPROVED
  REJECTED
  HIDDEN
}

enum ReactionType {
  LIKE
  DISLIKE
}

enum ReportReason {
  SPAM
  INAPPROPRIATE
  DUPLICATE
  OTHER
}

enum SubscriptionTier {
  FREE
  PRO
  ENTERPRISE
}

// Auth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  emailVerified     DateTime?
  name              String?
  image             String?
  role              Role      @default(STUDENT)
  onboardingComplete Boolean  @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  profile       UserProfile?
  savedProjects SavedProject[]
  communityIdeas CommunityIdea[]
  ideaReactions IdeaReaction[]
  ideaReports   IdeaReport[]
  aiUsageLogs   AIUsageLog[]
  downloads     Download[]
  subscription  Subscription?
  auditLogs     AuditLog[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model UserProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Onboarding preferences
  preferredDomains  String[] // Array of ProjectDomain values
  skillLevel        String?  // BEGINNER, INTERMEDIATE, ADVANCED
  academicYear      String?
  institution       String?
  
  // Profile details
  bio               String?
  github            String?
  linkedin          String?
  portfolio         String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@map("user_profiles")
}

model Project {
  id              String            @id @default(cuid())
  slug            String            @unique
  title           String
  shortDescription String
  fullDescription String            @db.Text
  
  // Classification
  domain          ProjectDomain
  difficulty      ProjectDifficulty
  estimatedDuration String
  recommendedYear String
  primaryTechnology String
  
  // Structured content (JSON)
  techStack       Json              // { frontend: [], backend: [], database: [], tools: [] }
  architecture    String            @db.Text
  features        Json              // Array of feature strings
  skillsRequired  Json              // Array of skill strings
  learningOutcomes Json             // Array of outcome strings
  timeline        Json              // Array of { week, title, description }
  
  // Metadata
  isPublished     Boolean           @default(true)
  isEditorPick    Boolean           @default(false)
  viewCount       Int               @default(0)
  saveCount       Int               @default(0)
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  savedBy         SavedProject[]
  downloads       Download[]
  editorPick      EditorPick?

  // Single column indexes
  @@index([slug])
  @@index([domain])
  @@index([difficulty])
  @@index([recommendedYear])
  @@index([primaryTechnology])
  @@index([isPublished])
  @@index([isEditorPick])
  @@index([createdAt])
  
  // Composite indexes for common query patterns (PERFORMANCE OPTIMIZATION)
  @@index([isPublished, domain, difficulty]) // Filter by domain + difficulty
  @@index([isPublished, primaryTechnology]) // Filter by tech stack
  @@index([isPublished, recommendedYear]) // Filter by year
  @@index([isPublished, estimatedDuration]) // Filter by duration
  @@index([isPublished, isEditorPick, createdAt]) // Default listing with editor picks first
  @@index([isPublished, domain, isEditorPick, createdAt]) // Domain filtering with sorting
  @@index([domain, difficulty, primaryTechnology]) // Multi-filter queries
  @@index([title]) // Search optimization
  @@index([shortDescription]) // Search optimization
  
  @@map("projects")
}

model SavedProject {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
  @@map("saved_projects")
}

model CommunityIdea {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title       String
  description String
  domain      ProjectDomain
  tags        String[]
  
  status      IdeaStatus  @default(PENDING)
  likeCount   Int         @default(0)
  dislikeCount Int        @default(0)
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  reactions   IdeaReaction[]
  reports     IdeaReport[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("community_ideas")
}

model IdeaReaction {
  id        String       @id @default(cuid())
  userId    String
  ideaId    String
  type      ReactionType
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  idea      CommunityIdea @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())

  @@unique([userId, ideaId])
  @@index([ideaId])
  @@index([userId])
  @@map("idea_reactions")
}

model IdeaReport {
  id        String       @id @default(cuid())
  userId    String
  ideaId    String
  reason    ReportReason
  details   String?
  resolved  Boolean      @default(false)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  idea      CommunityIdea @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([ideaId])
  @@index([userId])
  @@index([resolved])
  @@map("idea_reports")
}

model AIUsageLog {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  action        String   // "customize_project", "generate_roadmap"
  projectId     String?
  tokensUsed    Int
  success       Boolean
  errorMessage  String?
  
  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("ai_usage_logs")
}

model Download {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  format    String   // "PDF"
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([projectId])
  @@index([createdAt])
  @@map("downloads")
}

model Subscription {
  id              String           @id @default(cuid())
  userId          String           @unique
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  tier            SubscriptionTier @default(FREE)
  status          String           @default("active") // active, cancelled, expired
  
  // Usage limits
  aiCallsUsed     Int              @default(0)
  aiCallsLimit    Int              @default(5)
  downloadsUsed   Int              @default(0)
  downloadsLimit  Int              @default(3)
  
  // Billing
  stripeCustomerId String?
  stripePriceId    String?
  stripeSubscriptionId String?
  
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@index([userId])
  @@index([tier])
  @@map("subscriptions")
}

model EditorPick {
  id        String   @id @default(cuid())
  projectId String   @unique
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  reason    String?
  order     Int      @default(0)
  createdAt DateTime @default(now())

  @@index([order])
  @@map("editor_picks")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action    String   // "login", "logout", "create_idea", "moderate_idea", etc.
  resource  String?  // Resource type: "user", "idea", "project"
  resourceId String? // ID of the resource
  metadata  String?  // JSON string for additional data
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}
